<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistiche Voti</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .stats-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            overflow-x: auto;
        }
        
        .stats-card {
            background: var(--card-background);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }
        
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .stats-title {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        .stats-table th,
        .stats-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--shadow-color);
        }
        
        .stats-table th {
            background-color: var(--background-color);
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .vote-value {
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .timestamp {
            color: var(--text-color);
            opacity: 0.7;
            font-size: 0.9em;
        }
        
        /* Stili per i badge degli utenti votanti */
        .voters-inline-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            max-width: 100%;
        }
        
        .voter-badge {
            display: flex;
            align-items: center;
            background-color: rgba(52, 152, 219, 0.1);
            border-radius: 20px;
            padding: 4px 8px;
            font-size: 0.85rem;
            white-space: nowrap;
            transition: all 0.2s ease;
            border-left: 3px solid var(--primary-color);
        }
        
        .voter-badge:hover {
            transform: translateY(-2px);
            background-color: rgba(52, 152, 219, 0.2);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        
        .voter-name {
            margin-right: 6px;
            font-weight: 500;
        }
        
        .voter-badge-rating {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .voters-cell {
            max-width: 300px;
            overflow-x: auto;
            padding: 8px 12px;
        }
        
        /* Stili per rendere la tabella scrollabile */
        .stats-table th,
        .stats-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--shadow-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .stats-table th:nth-child(4),
        .stats-table td:nth-child(4) {
            white-space: normal;
            width: 300px;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-container">
            <div class="navbar-logo">
                <a href="index.html">Twine Library</a>
            </div>
            <div class="navbar-breadcrumb" id="breadcrumb">
                <span class="breadcrumb-item">Home</span>
                <span class="breadcrumb-item active">Statistiche</span>
            </div>
            <div class="navbar-actions">
                <button id="dark-mode-toggle" class="navbar-btn">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="stats-container">
        <div class="stats-card">
            <div class="stats-header">
                <h2 class="stats-title">Statistiche Voti</h2>
            </div>
            <div id="stats-content">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>Scuola</th>
                            <th>Classe</th>
                            <th>Progetto</th>
                            <th>Utenti Votanti</th>
                            <th>Voto Medio</th>
                            <th>Num. Voti</th>
                        </tr>
                    </thead>
                    <tbody id="stats-body">
                        <!-- I dati verranno inseriti qui dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Funzione per caricare i voti
        async function loadVotes() {
            try {
                // Carica i dati dei voti
                const votesResponse = await fetch('../server/votes.json');
                const votesData = await votesResponse.json();
                
                // Carica i dati dei progetti
                const projectsResponse = await fetch('../server/projects.json');
                const projectsData = await projectsResponse.json();
                
                const statsBody = document.getElementById('stats-body');
                statsBody.innerHTML = '';
                
                // Organizza i voti per progetto
                const projectVotes = {};
                
                // Itera su tutti gli utenti e i loro voti
                for (const [username, userVotes] of Object.entries(votesData)) {
                    for (const [projectId, voteValue] of Object.entries(userVotes)) {
                        // Salta se non è un voto valido (potrebbe essere un timestamp o altro)
                        if (typeof voteValue !== 'number') continue;
                        
                        if (!projectVotes[projectId]) {
                            projectVotes[projectId] = {
                                id: projectId,
                                voters: []
                            };
                        }
                        
                        projectVotes[projectId].voters.push({
                            username: username,
                            vote: voteValue
                        });
                    }
                }
                
                // Trova i dettagli dei progetti
                for (const projectId in projectVotes) {
                    const project = findProjectById(projectsData, projectId);
                    if (project) {
                        projectVotes[projectId].name = project.name;
                        projectVotes[projectId].school = project.school;
                        projectVotes[projectId].class = project.class;
                    }
                }
                
                // Converti in array e ordina per numero di voti (decrescente)
                const projectsArray = Object.values(projectVotes)
                    .filter(p => p.name) // Filtra solo i progetti con un nome valido
                    .sort((a, b) => b.voters.length - a.voters.length);
                
                // Popola la tabella
                projectsArray.forEach(project => {
                    const row = document.createElement('tr');
                    
                    // Calcola il voto medio
                    const totalVotes = project.voters.length;
                    const avgVote = totalVotes > 0 
                        ? (project.voters.reduce((sum, voter) => sum + voter.vote, 0) / totalVotes).toFixed(1)
                        : '0.0';
                    
                    // Crea una lista di utenti votanti
                    const votersList = document.createElement('div');
                    votersList.className = 'voters-inline-list';
                    
                    project.voters.forEach(voter => {
                        const voterBadge = document.createElement('div');
                        voterBadge.className = 'voter-badge';
                        voterBadge.innerHTML = `
                            <span class="voter-name">${voter.username}</span>
                            <span class="voter-badge-rating">${voter.vote}</span>
                        `;
                        votersList.appendChild(voterBadge);
                    });
                    
                    // Popola la riga
                    row.innerHTML = `
                        <td>${formatSchoolName(project.school)}</td>
                        <td>${project.class}</td>
                        <td>${project.name}</td>
                        <td class="voters-cell"></td>
                        <td class="vote-value">${avgVote}</td>
                        <td>${totalVotes}</td>
                    `;
                    
                    // Aggiungi la lista di utenti votanti alla cella
                    const votersCell = row.querySelector('.voters-cell');
                    votersCell.appendChild(votersList);
                    
                    // Aggiungi la riga alla tabella
                    statsBody.appendChild(row);
                });
                
                // Nessun event listener necessario, ora i votanti sono visualizzati direttamente nella tabella
                
            } catch (error) {
                console.error('Error loading votes:', error);
                document.getElementById('stats-content').innerHTML = 
                    '<p>Errore nel caricamento delle statistiche. Riprova più tardi.</p>';
            }
        }
        
        // Funzione per trovare un progetto per ID
        function findProjectById(projectsData, projectId) {
            for (const schoolName in projectsData) {
                for (const className in projectsData[schoolName]) {
                    const projects = projectsData[schoolName][className];
                    const project = projects.find(p => p.id === projectId);
                    if (project) {
                        return {
                            ...project,
                            school: schoolName,
                            class: className
                        };
                    }
                }
            }
            return null;
        }
        
        // Funzione per formattare il nome della scuola
        function formatSchoolName(schoolName) {
            return schoolName.replace(/_/g, ' ')
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }
        
        // Funzione per ordinare i progetti
        function sortProjects(projects, sortBy = 'votes') {
            return [...projects].sort((a, b) => {
                if (sortBy === 'votes') {
                    return b.voters.length - a.voters.length;
                } else if (sortBy === 'rating') {
                    const aAvg = a.voters.length > 0 
                        ? a.voters.reduce((sum, voter) => sum + voter.vote, 0) / a.voters.length
                        : 0;
                    const bAvg = b.voters.length > 0 
                        ? b.voters.reduce((sum, voter) => sum + voter.vote, 0) / b.voters.length
                        : 0;
                    return bAvg - aAvg;
                } else if (sortBy === 'name') {
                    return a.name.localeCompare(b.name);
                }
                return 0;
            });
        }

        // Gestione dark mode
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const isDarkMode = localStorage.getItem('darkMode') === 'true';

        if (isDarkMode) {
            document.documentElement.classList.remove('light-mode');
            document.documentElement.classList.add('dark-mode');
            darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        }

        darkModeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark-mode');
            document.documentElement.classList.toggle('light-mode', !isDark);
            darkModeToggle.innerHTML = isDark ? 
                '<i class="fas fa-sun"></i>' : 
                '<i class="fas fa-moon"></i>';
            localStorage.setItem('darkMode', isDark);
        });

        // Carica i voti all'avvio
        loadVotes();
    </script>
</body>
</html> 